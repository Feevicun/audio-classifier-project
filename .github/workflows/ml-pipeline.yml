name: ML Training and Deployment Pipeline

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  
  pull_request:
    branches: [ main, master ]
  
  workflow_dispatch:
    inputs:
      training_epochs:
        description: 'Number of training epochs'
        required: true
        default: '2'
        type: string
      use_minimal_data:
        description: 'Use minimal dataset to save space'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_TRAIN: ${{ github.repository }}-train
  IMAGE_NAME_INFERENCE: ${{ github.repository }}-inference
  MODEL_ARTIFACT_NAME: trained-model

jobs:
  # Job 1: –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—î—é –ø–∞–º'—è—Ç—ñ
  train-model:
    name: Train ML Model
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Free disk space
      run: |
        echo "üßπ Freeing up disk space..."
        sudo apt-get clean
        docker system prune -f || true
        df -h
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build optimized training image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.train
        tags: train-image:latest
        load: true
        outputs: type=docker,dest=/tmp/train-image.tar
    
    - name: Load training image
      run: |
        echo "üì¶ Loading training image..."
        docker load --input /tmp/train-image.tar
        docker images
    
    - name: Train with minimal data
      id: train
      run: |
        echo "üöÄ Starting model training with minimal data..."
        
        # –û—á–∏—â–∞—î–º–æ –º—ñ—Å—Ü–µ –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è–º
        sudo rm -rf /var/lib/apt/lists/*
        docker system prune -f
        
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è
        docker run --rm \
          -v $(pwd):/app \
          -e EPOCHS=${{ github.event.inputs.training_epochs || '2' }} \
          -e SAMPLES_PER_CLASS=10 \
          train-image:latest
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
        if [ -f "model.pth" ]; then
          echo "‚úÖ Model trained successfully"
          echo "training-status=success" >> $GITHUB_OUTPUT
          
          if [ -f "training.log" ]; then
            ACCURACY=$(grep "Accuracy:" training.log | tail -1 | grep -o '[0-9]*\.[0-9]*' | head -1 || echo "0")
            echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
            echo "üìä Final Accuracy: $ACCURACY%"
          fi
        else
          echo "‚ùå Model training failed"
          echo "training-status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Upload trained model
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.MODEL_ARTIFACT_NAME }}
        path: |
          model.pth
          class_info.json
          training.log
        retention-days: 30

  # Job 2: –ë—ñ–ª–¥ inference —Å–µ—Ä–≤–µ—Ä–∞
  build-inference:
    name: Build Inference Server
    runs-on: ubuntu-latest
    needs: train-model
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download trained model
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.MODEL_ARTIFACT_NAME }}
        path: ./
    
    - name: Build inference image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.inference
        tags: inference-image:latest
        load: true
    
    - name: Test inference server
      run: |
        echo "üß™ Testing inference server..."
        
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä
        docker run -d --name test-server -p 5000:5000 inference-image:latest
        sleep 10
        
        # –¢–µ—Å—Ç—É—î–º–æ health check
        curl -f http://localhost:5000/health || echo "Health check failed"
        
        # –ó—É–ø–∏–Ω—è—î–º–æ —Å–µ—Ä–≤–µ—Ä
        docker stop test-server
        docker rm test-server

  # Job 3: –§—ñ–Ω–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç
  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [train-model, build-inference]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create summary
      run: |
        echo "üéâ Pipeline completed successfully!"
        echo "‚úÖ Model trained and saved"
        echo "‚úÖ Inference server built"
        echo "üöÄ Ready for deployment"